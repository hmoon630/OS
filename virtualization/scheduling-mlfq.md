# 멀티 레벨 피드백 큐 (Multi Level Feedback Queue, MLFQ)

**MLFQ**는 응답이 빠른 시스템을 만드는 동시에 RR과 달리 반환 시간이 최악이었던 것을 해결한 스케줄링 방법이다. 실행 시간에 대한 정보도 없이 응답 시간과 반환 시간을 모두 줄이는 방법을 아래에서 다룬다.

# MLFQ 기본 규칙

MLFQ는 기본적으로 여러개의 **큐**로 구성이 되어 있고, 각 큐는 다른 **우선 순위(priority level)** 를 가진다. 

MLFQ에서 스케줄링의 우선 순위를 어떻게 정하는 지가 중요한데, 작업이 어떤 특성을 가지고 동작하는가에 따라 우선 순위를 부여한다. 예를 들어 어떤 작업이 키보드 입력을 기다리며 CPU를 양보한다면 큐에서 높은 우선 순위를 유지해준다. 

MLFQ의 기본 규칙 중 2가지는 다음과 같다.

1. A의 우선 순위가 B보다 높으면 A를 우선 실행한다.
2. A와 B의 우선 순위가 같다면 RR 방식으로 실행한다.

# 우선 순위 변경
MLFQ에서 우선 순위를 변경하기 위해서 다음과 같은 규칙이 추가된다.

3. 작업이 시스템에 들어가면 최상위 큐에 배치된다.
4. 타임 슬라이스를 다 소진하면 우선 순위가 내려간다.
5. 타임 슬라이스를 소진하기 전에 CPU를 양보하면 우선 순위가 유지된다.

위의 2가지 규칙으로 큐에 있는 작업이 실행 되면 우선 순위가 점점 내려가게 된다. 또한 새로 들어온 작업이 짧은 작업일 것이라 가정하고 최상위 큐에 배치 시키기 때문에 실제로 짧은 경우 빠르게 끝날 수 있다.

5번의 규칙을 보면 대화형 프로세스를 위해 CPU를 양보한 경우 우선 순위를 유지할 수 있도록 했다. 하지만 이를 악용 하면 타임 슬라이스를 99% 까지만 사용하고 CPU를 양보하면 계속해서 CPU를 독점할 수 있게 된다. 따라서 4번과 5번의 규칙을 수정하여 다음과 같이 조정할 수 있다.

4. 작업이 **지정된 단계에서 배정받은 시간을 소진하면**(CPU를 반환한 횟수는 고려하지 않는다.) 작업의 우선 순위가 내려간다.

# 현재까지의 문제점

만약 대화형 작업이 너무 많아 대화형 작업끼리만 자원을 사용하면 다른 작업들은 자원을 받지 못해 **기아(starvation)** 상태가 될 수 있다. 이를 해결하기 위해 일정 시간이 지나면 낮은 우선 순위에 있던 작업들도 다시 최상위 우선 순위로 올려주는 방식을 택했다.

5. 일정 주기 S가 지난 후, 시스템의 모든 작업을 최상위 큐로 이동시킨다.

# 정리

MLFQ가 흥미로운 이유는 작업들에 대한 정보 없이 작업들이 실행한 행동만을 기반으로 우선 순위를 예측하여 실행한다는 것이다. 게다가 짧게 실행되는 대화형 작업들에게는 성능을 제공하고, 다른 작업들에게도 공정하게 실행할 기회를 준다. 

이 MLFQ 스케줄러는 BSD UNIX와 거기서 파생된 OS, Windows를 포함한 많은 시스템에게 사용되고 있다.
